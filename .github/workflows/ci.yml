name: ci

on: [pull_request]

jobs:
  ci:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: pip install ruff pytest requests
    
    - name: Lint with ruff
      run: ruff check .
    
    - name: Build Docker images
      run: |
        docker build -t api ./services/api
        docker build -t router ./services/router
    
    - name: Start services for testing
      run: |
        docker compose -f infra/docker-compose.yml up -d
        
        # Wait for services to be ready
        timeout 60s bash -c 'until curl -sf http://localhost:8000/health; do sleep 2; done'
        timeout 60s bash -c 'until curl -sf http://localhost:7000/health; do sleep 2; done'
    
    - name: Run tests
      run: pytest -q
    
    - name: Cleanup
      if: always()
      run: docker compose -f infra/docker-compose.yml down -v